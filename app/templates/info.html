<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»è¦ä¿¡æ¯</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-color: #e0f7fa;
            font-family: 'Arial', sans-serif;
        }

        .info-content {
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin: 20px;
            overflow-y: auto;
            text-align: center;
        }

        .info-content h2 {
            color: #00796b;
        }

        .info-content p {
            color: #004d40;
        }

        /* æ–°å¢å›¾è¡¨å¸ƒå±€æ ·å¼ */
        .chart-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .chart-row {
            display: flex;
            gap: 20px;
            height: 45vh;
            /* æ¯è¡Œå è§†å£é«˜åº¦çš„45% */
        }

        .chart-container {
            flex: 1;
            min-width: 0;
            /* é˜²æ­¢å†…å®¹æº¢å‡º */
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* æ–°å¢äº¤äº’å¼å›¾è¡¨å®¹å™¨æ ·å¼ */
        .interactive-chart-container {
            position: relative;
            margin-top: 40px;
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        /* å±æ€§åˆ‡æ¢æŒ‰é’®ç»„ */
        .attribute-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        /* é±¼ç±»é€‰æ‹©æŒ‰é’®ç»„ */
        .species-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        .chart-btn {
            padding: 8px 15px;
            border: 1px solid #00796b;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #00796b;
        }

        .chart-btn.active {
            background: #00796b;
            color: white;
        }

        /* äº¤äº’å›¾è¡¨å®¹å™¨ */
        #dynamicChart {
            height: 500px;
            margin-top: 50px;
        }

        #water-alert div {
            font-size: 14px;
        }
    </style>

</head>

<body>
    <div class="info-content">
        <h2>ä¸»è¦ä¿¡æ¯</h2>
        <div class="chart-grid">
            <!-- ç¬¬ä¸€è¡Œ -->
            <div class="chart-row">
                <div class="chart-container" id="chart1"></div>
                <div class="chart-container" id="chart2"></div>
            </div>
            <!-- ç¬¬äºŒè¡Œ
            <div class="chart-row">
                <div class="chart-container" id="chart3"></div>
                <div class="chart-container" id="chart4"></div>
            </div> -->
            <!-- ç¬¬äºŒè¡Œ -->
            <div class="chart-row">
                <!-- å·¦ä¾§æ°´è´¨å›¾è¡¨åŠæŠ¥è­¦ -->
                <div class="chart-container">
                    <div id="chart3" style="height: 250px;"></div>
                    <div id="water-alert" style="margin-top: 10px;"></div>
                </div>
                <!-- å³ä¾§ç¯å¢ƒè¯„åˆ†ä»ªè¡¨ç›˜ -->
                <div class="chart-container" id="chart4"></div>
            </div>

        </div>

        <!-- æ–°å¢äº¤äº’å¼å›¾è¡¨åŒºåŸŸ -->
        <!-- <div class="interactive-chart-container">
            <div class="attribute-switcher">
                <button class="chart-btn active" data-type="weight">é‡é‡</button>
                <button class="chart-btn" data-type="length">é•¿åº¦</button>
                <button class="chart-btn" data-type="width">å®½åº¦</button>
            </div>
            <div id="dynamicChart"></div>
            <div class="species-selector">
                <button class="chart-btn active" data-species="all">å…¨éƒ¨</button>
                <button class="chart-btn" data-species="Perch">Perch</button>
                <button class="chart-btn" data-species="Bream">Bream</button>
                <button class="chart-btn" data-species="Roach">Roach</button>
                <button class="chart-btn" data-species="Pike">Pike</button>
                <button class="chart-btn" data-species="Smelt">Smelt</button>
                <button class="chart-btn" data-species="Parkki">Parkki</button>
                <button class="chart-btn" data-species="Whitefish">Whitefish</button>
            </div>
        </div> -->
    </div>

    <script>
        // é€šç”¨å›¾è¡¨åˆå§‹åŒ–å‡½æ•°
        function initChart(domId, option) {
            const chart = echarts.init(document.getElementById(domId));
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
            return chart;
        }

        // é±¼ç¾¤ç§ç±»é¥¼å›¾
        initChart('chart1', {
            title: { text: 'é±¼ç¾¤ç§ç±»ç»Ÿè®¡', left: 'center' },
            tooltip: { trigger: 'item' },
            legend: { orient: 'vertical', left: 'left' },
            series: [{
                type: 'pie',
                radius: '50%',
                data: {{ species_data| tojson}}
            }]
        });

        // è·å–é«˜å¾·åœ°å›¾å¤©æ°”æ•°æ®
        function fetchWeatherData(cityAdcode, key) {
            return new Promise((resolve, reject) => {
                fetch(`https://restapi.amap.com/v3/weather/weatherInfo?city=${cityAdcode}&extensions=all&key=${key}&output=json`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === "1" && data.info === "OK") {
                            resolve(data);
                        } else {
                            reject(new Error("Failed to fetch weather data"));
                        }
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        }

        // å¤„ç†å¤©æ°”æ•°æ®å¹¶ç”ŸæˆæŸ±çŠ¶å›¾
        function generateChart(cityAdcode, key) {
            fetchWeatherData(cityAdcode, key)
                .then(data => {
                    // è·å–æœªæ¥å‡ å¤©çš„å¤©æ°”é¢„æŠ¥æ•°æ®
                    const forecasts = data.forecasts[0].casts;

                    // æå–æ—¥æœŸã€æœ€é«˜æ¸©åº¦å’Œæœ€ä½æ¸©åº¦
                    const dates = forecasts.map(forecast => forecast.date);
                    const highs = forecasts.map(forecast => parseFloat(forecast.daytemp));
                    const lows = forecasts.map(forecast => parseFloat(forecast.nighttemp));

                    // åˆå§‹åŒ–æŸ±çŠ¶å›¾
                    initChart('chart2', {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        legend: {
                            data: ['æœ€é«˜æ¸©åº¦', 'æœ€ä½æ¸©åº¦']
                        },
                        xAxis: {
                            type: 'category',
                            data: dates
                        },
                        yAxis: {
                            name: 'æ¸©åº¦',
                            type: 'value',
                            axisLabel: {
                                formatter: '{value} Â°C'
                            }
                        },
                        series: [
                            {
                                name: 'æœ€é«˜æ¸©åº¦',
                                type: 'bar',
                                data: highs,
                                markLine: {
                                    data: [
                                        { type: 'average', name: 'å¹³å‡å€¼' }
                                    ]
                                }
                            },
                            {
                                name: 'æœ€ä½æ¸©åº¦',
                                type: 'bar',
                                data: lows,
                                markLine: {
                                    data: [
                                        { type: 'average', name: 'å¹³å‡å€¼' }
                                    ]
                                }
                            }
                        ]
                    });
                })
                .catch(error => {
                    console.error("Error fetching weather data:", error);
                });
        }

        // åŸå¸‚ç¼–ç å’Œé«˜å¾·åœ°å›¾ API Key
        const cityAdcode = '120100'; // å¤©æ´¥å¸‚çš„ adcode
        const apiKey = '8c3e8f0f8fdb5a0a99e2e7be9c28fb93';
        generateChart(cityAdcode, apiKey);

        // æ°´è´¨ç¯å¢ƒæŒ‡æ ‡
        function fetchWaterDataAndGenerateChart() {
            fetch('/getWaterData')
                .then(response => {
                    if (!response.ok) throw new Error("Failed to fetch water data");
                    return response.json();
                })
                .then(data => {
                    const [temperature, ph, dissolved_oxygen, conductivity, turbidity, permanganate_index] = data;

                    const chartData = [
                        ['score', 'series'],
                        [ph, 'pH(æ— é‡çº²)'],
                        [dissolved_oxygen, 'æº¶è§£æ°§(mg/L)'],
                        [conductivity, 'ç”µå¯¼ç‡(Î¼S/cm)'],
                        [turbidity, 'æµŠåº¦(NTU)'],
                        [permanganate_index, 'é«˜é”°é…¸ç›æŒ‡æ•°(mg/L)'],
                        [temperature, 'æ°´æ¸©(â„ƒ)']
                    ];

                    // ========== æŠ¥è­¦åˆ¤æ–­ ==========
                    const alertMessages = [];
                    if (ph < 6 || ph > 9) alertMessages.push(`âš ï¸ pH å€¼å¼‚å¸¸ï¼ˆå½“å‰å€¼: ${ph}ï¼‰`);
                    if (dissolved_oxygen < 5) alertMessages.push(`âš ï¸ æº¶è§£æ°§åä½ï¼ˆå½“å‰å€¼: ${dissolved_oxygen} mg/Lï¼‰`);
                    if (permanganate_index > 6) alertMessages.push(`âš ï¸ é«˜é”°é…¸ç›æŒ‡æ•°åé«˜ï¼ˆå½“å‰å€¼: ${permanganate_index} mg/Lï¼‰`);
                    if (turbidity > 10) alertMessages.push(`âš ï¸ æµŠåº¦åé«˜ï¼ˆå½“å‰å€¼: ${turbidity} NTUï¼‰`);
                    if (temperature > 30) alertMessages.push(`âš ï¸ æ°´æ¸©åé«˜ï¼ˆå½“å‰å€¼: ${temperature}â„ƒï¼‰`);

                    // æ’å…¥è­¦æŠ¥ä¿¡æ¯
                    const alertBox = document.getElementById('water-alert');
                    alertBox.innerHTML = '';

                    const alertContainer = document.createElement('div');  // å…ˆåˆ›å»º
                    alertContainer.style.padding = "15px";
                    alertContainer.style.borderRadius = "8px";
                    alertContainer.style.fontWeight = "bold";


                    if (alertMessages.length > 0) {
                        alertContainer.style.border = "2px solid red";
                        alertContainer.style.color = "red";
                        alertContainer.innerHTML = `<h4>ğŸš¨ æŠ¥è­¦ä¿¡æ¯ï¼š</h4><ul>` +
                            alertMessages.map(msg => `<li>${msg}</li>`).join('') + `</ul>`;
                    } else {
                        alertContainer.style.border = "2px solid #28a745";
                        alertContainer.style.color = "#28a745";
                        alertContainer.innerHTML = `âœ… å½“å‰æ°´è´¨æŒ‡æ ‡å…¨éƒ¨æ­£å¸¸`;
                    }

                    alertBox.appendChild(alertContainer);

                    // === å›¾è¡¨æ¸²æŸ“ ===
                    initChart('chart3', {
                        dataset: {
                            source: chartData
                        },
                        grid: { containLabel: true },
                        xAxis: {},
                        yAxis: { type: 'category' },
                        visualMap: {
                            orient: 'horizontal',
                            left: 'center',
                            min: 0,
                            max: 150,
                            text: ['High Score', 'Low Score'],
                            dimension: 0,
                            inRange: {
                                color: ['#65B581', '#FFCE34', '#FD665F']
                            },
                            formatter: function (value) {
                                return value.toFixed(2);
                            }
                        },
                        series: [
                            {
                                type: 'bar',
                                encode: {
                                    y: 'series',
                                    x: 'score'
                                }
                            }
                        ]
                    });
                })
                .catch(error => {
                    console.error("Error fetching water data:", error);
                });
        }

        // è°ƒç”¨å‡½æ•°ç”Ÿæˆå›¾è¡¨
        fetchWaterDataAndGenerateChart();

        // ç¯å¢ƒåˆ†æ•°è®¡ç®—
        initChart('chart4', {
            series: [
                {
                    type: 'gauge',
                    startAngle: 180,
                    endAngle: 0,
                    center: ['50%', '75%'],
                    radius: '90%',
                    min: 0,
                    max: 1,
                    splitNumber: 8,
                    axisLine: {
                        lineStyle: {
                            width: 6,
                            color: [
                                [0.25, '#FF6E76'],
                                [0.5, '#FDDD60'],
                                [0.75, '#58D9F9'],
                                [1, '#7CFFB2']
                            ]
                        }
                    },
                    pointer: {
                        icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',
                        length: '12%',
                        width: 20,
                        offsetCenter: [0, '-60%'],
                        itemStyle: {
                            color: 'auto'
                        }
                    },
                    axisTick: {
                        length: 12,
                        lineStyle: {
                            color: 'auto',
                            width: 2
                        }
                    },
                    splitLine: {
                        length: 20,
                        lineStyle: {
                            color: 'auto',
                            width: 5
                        }
                    },
                    axisLabel: {
                        color: '#464646',
                        fontSize: 20,
                        distance: -60,
                        rotate: 'tangential',
                        formatter: function (value) {
                            if (value === 0.875) {
                                return 'èˆ’é€‚';
                            } else if (value === 0.625) {
                                return 'æ­£å¸¸';
                            } else if (value === 0.375) {
                                return 'éšæ‚£';
                            } else if (value === 0.125) {
                                return 'å±é™©';
                            }
                            return '';
                        }
                    },
                    title: {
                        offsetCenter: [0, '-10%'],
                        fontSize: 20
                    },
                    detail: {
                        fontSize: 30,
                        offsetCenter: [0, '-35%'],
                        valueAnimation: true,
                        formatter: function (value) {
                            return Math.round(value * 100) + '';
                        },
                        color: 'inherit'
                    },
                    data: [
                        {
                            value: 0.68,
                            name: 'ç¯å¢ƒå¾—åˆ†'
                        }
                    ]
                }
            ]
        });



        
    //     // åŠ¨æ€å›¾è¡¨é…ç½®
    //     let currentDataType = 'weight';
    //     let currentSpecies = 'all';
    //     let dynamicChart = echarts.init(document.getElementById('dynamicChart'));

    //     // è·å– X è½´èŒƒå›´æ•°æ®
    //     function getXAxisRanges(type) {
    //         const ranges = {
    //             weight: ['0-50kg', '50-100kg', '100-150kg', '150-200kg', '200-250kg', '250-300kg', '>300kg'],
    //             length: ['0-20cm', '20-40cm', '40-60cm', '60-80cm', '80-100cm', '100-120cm', '>120cm'],
    //             width: ['0-10cm', '10-20cm', '20-30cm', '30-40cm', '40-50cm', '50-60cm', '>60cm']
    //         };
    //         return ranges[type] || [];
    //     }

    //     // è·å– Y è½´å•ä½
    //     function getYAxisUnit(type) {
    //         return {
    //             weight: '(kg)',
    //             length: '(cm)',
    //             width: '(cm)'
    //         }[type] || '';
    //     }

    //     // è·å–æ•°æ®
    //     function fetchData(type, species) {
    //         return new Promise((resolve, reject) => {
    //             const url = `/get${type}?species=${species}`;
    //             fetch(url)
    //                 .then(response => response.json())
    //                 .then(data => resolve(data))
    //                 .catch(error => reject(error));
    //         });
    //     }

    //     // æ›´æ–°å›¾è¡¨å‡½æ•°
    //     async function updateDynamicChart() {
    //         try {
    //             // è·å–åŸå§‹æ•°æ®
    //             const rawData = await fetchData(currentDataType, currentSpecies);
    //             // è·å–Xè½´èŒƒå›´
    //             const ranges = getXAxisRanges(currentDataType);

    //             // åˆå§‹åŒ–ç»Ÿè®¡ç»“æœæ•°ç»„
    //             const rangeCounts = new Array(ranges.length).fill(0);

    //             // æ ¹æ®èŒƒå›´ç»Ÿè®¡æ•°æ®
    //             rawData.forEach(value => {
    //                 const numericValue = parseFloat(value);
    //                 ranges.forEach((range, index) => {
    //                     let min, max;
    //                     if (range.startsWith('>')) {
    //                         // å¤„ç†æ— ä¸Šé™èŒƒå›´ï¼Œå¦‚ '>300kg'
    //                         min = parseFloat(range.slice(1)); // å»æ‰ '>' ç¬¦å·
    //                         max = Infinity;
    //                     } else {
    //                         // å¤„ç†æ™®é€šèŒƒå›´ï¼Œå¦‚ '0-50kg'
    //                         const [minStr, maxStr] = range.split('-');
    //                         min = parseFloat(minStr);
    //                         max = parseFloat(maxStr);
    //                     }
    //                     if (numericValue >= min && numericValue < max) {
    //                         rangeCounts[index]++;
    //                     }
    //                 });
    //             });

    //             // æ„å»ºå›¾è¡¨é…ç½®
    //             const option = {
    //                 title: {
    //                     text: `${currentSpecies === 'all' ? 'å…¨éƒ¨' : currentSpecies}é±¼ç±»åˆ†å¸ƒ - ${getTypeLabel(currentDataType)}`,
    //                     left: 'center',
    //                     textStyle: {
    //                         fontSize: 18,
    //                         color: '#333'
    //                     }
    //                 },
    //                 tooltip: {
    //                     trigger: 'axis',
    //                     formatter: function (params) {
    //                         return `${params[0].marker} ${params[0].seriesName}<br/>
    //                                 ${params[0].axisValue}: ${params[0].data}æ¡`;
    //                     }
    //                 },
    //                 xAxis: {
    //                     type: 'category',
    //                     data: ranges,
    //                     axisLabel: {
    //                         rotate: 45,
    //                         interval: 0
    //                     },
    //                     axisLine: {
    //                         lineStyle: {
    //                             color: '#666'
    //                         }
    //                     }
    //                 },
    //                 yAxis: {
    //                     type: 'value',
    //                     name: `æ•°é‡ ${getYAxisUnit(currentDataType)}`,
    //                     nameTextStyle: {
    //                         color: '#666',
    //                         padding: [0, 0, 0, 20]
    //                     },
    //                     splitLine: {
    //                         show: true,
    //                         lineStyle: {
    //                             type: 'dashed'
    //                         }
    //                     }
    //                 },
    //                 series: [{
    //                     name: 'æ•°é‡åˆ†å¸ƒ',
    //                     type: 'line',
    //                     smooth: true,
    //                     symbol: 'circle',
    //                     symbolSize: 8,
    //                     lineStyle: {
    //                         color: '#00796b',
    //                         width: 3
    //                     },
    //                     itemStyle: {
    //                         color: '#00796b',
    //                         borderColor: '#fff',
    //                         borderWidth: 2
    //                     },
    //                     areaStyle: {
    //                         color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
    //                             offset: 0,
    //                             color: 'rgba(0,121,107,0.3)'
    //                         }, {
    //                             offset: 1,
    //                             color: 'rgba(0,121,107,0.01)'
    //                         }])
    //                     },
    //                     data: rangeCounts // ä½¿ç”¨ç»Ÿè®¡ç»“æœä½œä¸ºæ•°æ®
    //                 }],
    //                 grid: {
    //                     left: '3%',
    //                     right: '4%',
    //                     bottom: '15%',
    //                     containLabel: true
    //                 }
    //             };

    //             // æ›´æ–°å›¾è¡¨
    //             dynamicChart.setOption(option);
    //         } catch (error) {
    //             console.error('Error fetching or processing data:', error);
    //         }
    //     }

    //     // æŒ‰é’®ç‚¹å‡»å¤„ç†
    //     document.querySelectorAll('.chart-btn').forEach(btn => {
    //         btn.addEventListener('click', function () {
    //             if (this.dataset.type) {
    //                 document.querySelectorAll('[data-type]').forEach(b =>
    //                     b.classList.remove('active'));
    //                 this.classList.add('active');
    //                 currentDataType = this.dataset.type;
    //             }

    //             if (this.dataset.species) {
    //                 document.querySelectorAll('[data-species]').forEach(b =>
    //                     b.classList.remove('active'));
    //                 this.classList.add('active');
    //                 currentSpecies = this.dataset.species;
    //             }

    //             updateDynamicChart();
    //         });
    //     });

    //     // ç±»å‹æ ‡ç­¾è½¬æ¢
    //     function getTypeLabel(type) {
    //         return {
    //             weight: 'é‡é‡åˆ†å¸ƒ',
    //             length: 'é•¿åº¦åˆ†å¸ƒ',
    //             width: 'å®½åº¦åˆ†å¸ƒ'
    //         }[type];
    //     }

    //     // åˆå§‹åŒ–å›¾è¡¨
    //     updateDynamicChart();
    //     window.addEventListener('resize', () => dynamicChart.resize());
    // </script>
</body>

</html>